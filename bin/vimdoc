#!/usr/bin/env ruby

# Generates features list in markdown based on vim file
#
# Usage:
#   bin/docs < plugins/sensible.vim

paragraphs = $stdin.readlines.chunk { |line| line.strip.length == 0 }.map(&:last)

paragraphs.select! do |paragraph|
  paragraph.any?{ |line| line[0] == '"' }
  paragraph.last[0] != '"' || paragraph.first[0..1] == '""'
end

paragraphs.map! do |paragraph|
  {
    :header =>
      (paragraph.first[3..-2] if paragraph.first[0..1] == '""'),
    :comments =>
      paragraph.flat_map do |line|
        line[2..-2] if line && line[0] == '"'
      end.select{ |line| line && line.strip.size > 0 },
    :source =>
      paragraph.select do |line|
        line && line.strip[0] != '"' && line.strip.size > 0
      end
  }
end.reject! do |paragraph|
  paragraph[:header].nil? && (paragraph[:comments].empty? || paragraph[:source].empty?)
end

paragraphs.map! do |paragraph|
  if paragraph[:header]
    "### " + paragraph[:header] + "\n"
  else
    if ENV['SHORT']
      "* #{paragraph[:comments].join("\n  ")}"
    else
      "* #{paragraph[:comments].join("\n  ")}\n\n  \`\`\`vim\n  #{paragraph[:source].join("  ")}  \`\`\`\n"
    end
  end
end

puts paragraphs.join("\n")
